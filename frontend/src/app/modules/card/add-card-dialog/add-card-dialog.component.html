<div class="dialog-container">
  <h2 mat-dialog-title>Agregar Nueva Tarjeta</h2>
  <mat-tab-group>
    <!-- Scraper Autom치tico -->
    <mat-tab label="Autom치tico">
      <form [formGroup]="cardForm" (ngSubmit)="onSubmitScraper()">
        <div mat-dialog-content>
          <div class="form-content">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Banco</mat-label>
              <mat-select formControlName="bank">
                <mat-option *ngFor="let bank of banks" [value]="bank.name">
                  {{ bank.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>RUT</mat-label>
              <input matInput formControlName="rut" placeholder="12.345.678-9" (input)="onRutInput($event)" [errorStateMatcher]="matcher">
              <mat-error *ngIf="cardForm.get('rut')?.errors">
                {{ getErrorMessage('rut') }}
              </mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Contrase침a</mat-label>
              <input matInput type="password" formControlName="password" placeholder="Contrase침a del banco">
              <mat-error *ngIf="cardForm.get('password')?.errors">
                {{ getErrorMessage('password') }}
              </mat-error>
            </mat-form-field>
            <div *ngIf="loading" class="progress-container">
              <mat-progress-bar mode="determinate" [value]="progress" *ngIf="progress > 0"></mat-progress-bar>
              <mat-spinner diameter="30" *ngIf="progress === 0"></mat-spinner>
              <p class="status-message">{{statusMessage || 'Sincronizando con el banco, por favor espera...'}}</p>
              <p class="progress-message" *ngIf="progress > 0">Progreso: {{progress}}%</p>
              <p class="info-message">Este proceso puede tardar varios minutos. No cierres esta ventana.</p>
            </div>
            <div *ngIf="error" class="error-message">
              <mat-icon color="warn">error</mat-icon>
              <span>{{ error }}</span>
              <button mat-button color="primary" (click)="retrySync()" *ngIf="canRetry">
                <mat-icon>refresh</mat-icon>
                Reintentar
              </button>
            </div>
          </div>
        </div>
        <div mat-dialog-actions align="end">
          <button mat-button type="button" [disabled]="loading" (click)="onCancel()">Cancelar</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="cardForm.invalid || loading">
            <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
            <span *ngIf="!loading">Agregar Tarjeta</span>
          </button>
        </div>
      </form>
    </mat-tab>
    <!-- Manual -->
    <mat-tab label="Manual">
      <form [formGroup]="manualForm" (ngSubmit)="onManualSubmit()" class="manual-form">
        <div mat-dialog-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre de la tarjeta</mat-label>
            <input matInput formControlName="nameAccount" placeholder="Ej: Cuenta Rut, Visa Entel, etc.">
          </mat-form-field>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Alias (opcional)</mat-label>
            <input matInput formControlName="aliasAccount">
          </mat-form-field>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo de tarjeta</mat-label>
            <mat-select formControlName="cardTypeId" required>
              <mat-option *ngFor="let type of cardTypes" [value]="type.id">{{ type.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Banco (opcional)</mat-label>
            <mat-select formControlName="bankId">
              <mat-option *ngFor="let bank of banks" [value]="bank.id">{{ bank.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Saldo inicial</mat-label>
            <input matInput type="number" formControlName="balance" min="0" placeholder="Ej: 250000">
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="manualForm.invalid || isUploading">
            <mat-spinner *ngIf="isUploading" diameter="20"></mat-spinner>
            <span *ngIf="!isUploading">Agregar Tarjeta</span>
            <div *ngIf="manualError" class="manual-error-message">
              <mat-icon color="warn">error</mat-icon>
              {{ manualError }}
            </div>
          </button>
        </div>
      </form>
    </mat-tab>
  </mat-tab-group>
</div>
